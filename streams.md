# Настройка потоков

Управление трафиком в Adspect организовано в контексте потоков. Поток --- это канал прохождения трафика, которым
можно управлять как единым целым, подобно кампании в рекламной сети или схеме в TDS. Потоки управляются в разделе "Потоки"
вашего личного кабинета и создаются по кнопке "Создать поток". Далее мы рассмотрим назначение каждой настройки в потоке.

:::{note}
Настройки по умолчанию являются оптимальными для большинства источников трафика и сценариев использования. Вам не нужно заполнять
все доступные поля. Обычно достаточно указать только контент и белую страницу, а все остальное система Adspect сделает за вас.
:::

(basic-settings)=
## Общие настройки

(stream-name)=
### Название

Название потока --- это просто любое читабельное имя, которое позволит вам быстро отличить один поток от другого.
Мы рекомедуем называть потоки по именам рекламных сетей и кампаний в них для сохранения ясности связей между источниками
трафика и соответствующими потоками в Adspect.

(tags)=
### Теги

В этом поле вы можете указать до 32 мнемонических тегов, которые тем или иным образом описывают суть потока, например:
"нутра", "гэмблинг", "pay per call", "тест" и т.п. Вы можете делать поиск по этим тегам при помощи поля "Поиск" в верхнем
правом углу списка потоков.

(stream-mode)=
### Режим

Режим потока --- это главный рычаг управления, который определяет что делать с переходами.

:::{list-table} Режимы потока
:header-rows: 1

* - Режим
  - Описание

* - Фильтр
  - Основной режим работы, в котором происходит фильтрация переходов в реальном времени. Все технологии Adspect, в том числе
    [машинное обучение VLA™](how-it-works.md#vla), работают именно в этом режиме.

* - Модерация
  - Специальный режим, который **должен быть включен**, когда рекламные кампании находятся на модерации. Каждому посетителю будет
    показана белая страница. В этом режиме происходит обучение модели VLA™.

* - Контент
  - Вспомогательный режим, в котором всем посетителям показывается страница с основным контентом. Режим удобен для тестирования
    доступности контент-страницы.

* - Белая страница
  - Вспомогательный режим, в котором всем посетителям показывается белая страница. Режим удобен для тестирования доступности белой
    страницы. Рекомендуется переводить в этот режим потоки при остановке рекламных кампаний, так как система модерации многих
    рекламных сетей работает даже тогда, когда ваши кампании остановлены.
:::

"Модерация" является режимом по умолчанию для вновь созданных потоков. **Вам следует всегда использовать** этот режим при прохождении
модерации в рекламных сетях. После того, как кампания одобрена, переключите поток в режим "Фильтр" прежде, чем сеть начнет поставлять
трафик.

(notes)=
### Заметки

Это чисто информационное поле, в котором вы можете сохранить любые нужные вам заметки.

(money-and-safe-pages)=
## Контент и белая страница

(money-pages)=
### Контент

Контент --- это ваш настоящий лендинг или CPA-оффер, который вы собираетесь рекламировать. Словом, это то,
что должно приносить вам доход. Вы можете указать до 254 контент-страниц для сплит-тестирования. Трафик будет распределяться
между ними в соответствии с правилами выбранного ротатора (см. раздел "Ротатор" ниже).

В зависимости от выбранного действия (см. раздел "Действие" ниже), это поле может содержать разные значения:
ссылки, пути к файлам и директориям, код на языках PHP или JavaScript, и др. Если не брать в расчет специфические
действия, то основными видами значений являются ссылки и пути:

* **URL** --- это ссылка в привычном виде, в каком вы обычно указываете ее в адресной строке браузера.  Это может быть
  ваш оффер из CPA-сети, смартлинк, ссылка на кампанию в стороннем трекере, поток TDS и т.п. Ссылка *должна*
  начинаться с `http://` или `https://`, иначе система распознает ее как путь к файлу (см. ниже).

  Действия-редиректы также поддерживают различные не-HTTP URL-ы, при помощи которых вы можете выполнять специализированные
  задачи на устройствах ваших посетителей. Несколько распространенных примеров:

  * `mailto:user@example.com` откроет почтовую программу для составления e-mail на указанный адрес;
  * `tel:+08001234567` наберет указанный номер на мобильных устройствах и некоторых десктопах с ПО для телефонии;
  * `market://details?id=app` откроет страницу мобильного приложения в Google Play.

  Эта функциональность особенно полезна для работы с т.н. deep-ссылками, которые ведут на контент внутри мобильных приложений.

* **Путь к локальному файлу или директории,** например `page.php` или `/landers/landing.html`. Слово "локальный" в данном
  контексте означает, что файл или директория по указанному пути должны располагаться на том же сервере, на который
  загружен фильтрующий PHP-файл Adspect (эти файлы рассматриваются более детально в главе ["Интеграция"](integration.md)),
  то есть на том же домене, который будет использоваться для конечной "заклоаченной" ссылки. Пути в свою очередь делятся
  на абсолютные и относительные.

  Абсолютные пути начинаются с символа `/` и считаются относительно корневой директории сайта, т.е. от корня домена.
  Например, путь `/landers/landing.html` на домене `example.com` будет указывать на `https://example.com/landers/landing.html`.

  Относительные пути *не начинаются* с символа `/`, а их точная интерпретация зависит от типа интеграции.

(action)=
#### Действие

Это действие, которое будет совершено с посетителем.  Adspect поддерживает множество разных типов действий.
Как правило, вы будете пользоваться лишь парой или тройкой основных действий.

(parameter-passthrough)=
#### "ПП"

"ПП" --- это сокращение от "проброс URL-параметров". Если проброс параметров включен, то все параметры из входящей
ссылки будут добавлены к ссылке или имени файла контент-страницы.

Допустим, ваша страница указана в виде ссылки:
```
https://example.com/?utm_campaign=sweeps
```

Посетитель переходит на файл `index.php` потока по ссылке:
```
https://tracker.test/lander/index.php?utm_medium=ppc&utm_source=search
```

Если посетитель будет посчитан благонадежным, то он будет перенаправлен на контент-страницу с объединением параметров
из обеих ссылок выше:
```
https://example.com/?utm_campaign=sweeps&utm_medium=ppc&utm_content=search
```

(weight)=
#### Вес

Каждая контент-страница имеет свой абстрактный вес, который по умолчанию равен 10. Этот параметр учитывается при сплит-тестировании
нескольких контент-страниц. Конкретное влияние этого параметра на распределение трафика зависит от выбранного ротатора
(см. "Ротатор" ниже).

(page-on)=
#### "ВКЛ"

Настройка "ВКЛ" позволяет вам включать и выключать отдельные контент-страницы.  Это удобно для исключения
плохих офферов или лендингов из сплит-тестирования без их полного удаления из списка.

(money-page-rotator)=
### Ротатор контента

Ротатор контента определяет алгоритм ротации контент-страниц, т.е. то, как система выбирает, какую контент-страницу показать
каждому конкретному посетителю. Если указана только одна контент-страница, то выбор ротатора ни на что не влияет.

(split-rotator)=
#### Ротатор "сплит"

Это ротатор по умолчанию, который распределяет трафик между включенными контент-страницами в соответствии с их весами:
чем больше вес страницы, тем пропорционально больше трафика она получит.

Например, если у вас есть три контент-страницы с весами 10, 15 и 25, то первая страница получит 20&nbsp;% от всего
целевого трафика, вторая страница получит 30&nbsp;%, а третья --- 50&nbsp;%.

Так как этот ротатор имеет в основе генератор псевдослучайных чисел (PRNG), при небольшом числе входящих кликов могут
быть "перекосы" в распределении трафика относительно заданных весов. Однако, математические свойства PRNG гарантируют,
что на дистанции распределение трафика максимально точно достигнет заданных весов.

(timer-rotator)=
#### Ротатор "таймер"

Этот ротатор переключается между контент-страницами, используя вес как число секунд, на которое активируется та или иная страница.

Например, если у вас указаны три страницы с весами 60, 120 и 180, то первая страница будет показываться посетителям в течение
одной минуты, затем ротатор будет 2 минуты показывать вторую страницу, затем переключится на третью и будет отображать ее 3
минуты, а затем снова вернется к первой, и так далее.

Этот ротатор удобен для автоматической смены доменов по времени, особенно в тех случаях, когда домены быстро попадают
в черные списки антивирусных компаний.

(safe-page)=
### Белая страница

Белая страница (она же "вайт", "safe page", "white page") --- это безопасная страница, предназначенная для модераторов,
ботов, конкурентов и прочих нецелевых посетителей, которые не должны быть допущены на контент. Она не должна содержать
никакой чувствительный контент, который может поставить вашу рекламную кампанию под угрозу, например из-за нарушения
правил рекламной сети. Все, описанное выше для страницы контента, также относится и к белой странице: вы можете
использовать URL или имя файла для отображения. В случае с файлом, если ваша контент-страница также настроена как
файл, вам фактически потребуется совместить два лендинга в одной папке, с разными именами HTML- или PHP-файлов.

Мы настоятельно рекомендуем использовать полноценный собственный лендинг в качестве белой страницы. Это связано с тем,
что некоторые рекламные сети с подозрением относятся к любым редиректам, подвергая содержащие их кампании более тщательной
проверке, а некоторые и вовсе запрещают редиректы.

(macros)=
### URL-макросы

Adspect поддерживает макросы для использования в полях "Контент" и "Белая страница", а также в некоторых других полях настроек:

:::{list-table}
:header-rows: 1

* - Макрос
  - Описание

* - `{sid}`
  - ID потока.

* - `{aid}`
  - ID аккаунта.

* - `{host}`
  - Доменное имя запрошенного сайта.

* - `{ip}`
  - IP-адрес.

* - `{asn}`
  - [Номер автономной системы (ASN)](https://ru.wikipedia.org/wiki/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_(%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82)).

* - `{useragent}`
  - [Строка user agent](https://ru.wikipedia.org/wiki/User_agent).

* - `{referrer}`
  - [Referrer](https://developer.mozilla.org/ru/docs/Web/API/Document/referrer).

* - `{cost}`
  - [Цена перехода](streams.md#cost).

* - `{subid}`
  - [Sub ID](streams.md#sub-id).

* - `{clickid}`
  - [ID перехода](streams.md#click-id).

* - `{country}`
  - [Двухбуквенный код страны](https://ru.wikipedia.org/wiki/ISO_3166-1_alpha-2).

* - `{os}`
  - Операционная система.

* - `{browser}`
  - Браузер.

* - `{engine}`
  - Движок браузера.

* - `{unixtime}`
  - [Unix-время](https://ru.wikipedia.org/wiki/Unix-%D0%B2%D1%80%D0%B5%D0%BC%D1%8F) перехода.

* - `{tags}`
  - [Теги перехода](reporting.md#tags), если есть.

* - `{p:параметр}`
  - Значение указанного URL-параметра.

* - `{h:заголовок}`
  - Значение указанного заголовка запроса.
:::

При отображении страниц как локальных файлов вы также можете добавить параметры ссылки с макросами после имени файла,
и они будут переданы в PHP, где будут доступны через
[суперглобальную переменную `$_GET`](https://www.php.net/manual/ru/reserved.variables.get.php).

Пример использования в ссылке:
```
https://example.com/offer?clickid={clickid}&geo={country}&os={os}
```

Пример использования при отображении локального файла:
```
page.php?clickid={clickid}&geo={country}&os={os}
```
Далее значения этих макросов могут быть получены в коде страницы следующим образом:
```php
<a href="https://example.com/offer?clickid=<?= $_GET['clickid'] ?>">Offer</a>
```

(actions)=
## Действия

*Действия работают в соответствии с описанием только при использовании PHP-интеграции.* Поведение при использовании
JavaScript-интеграции описывается отдельно.

(local-file)=
### Локальный файл

Указанный локальный файл будет отображен без перенаправления (редиректа) путем выполнения его как PHP-скрипта,
либо прямой отдачи с сервера. **Этот способ наиболее безопасен, и мы настоятельно рекомендуем использовать его везде,
где это технически возможно.**

Файл можно указать несколькими способами:

- Абсолютные пути считаются относительно корня домена, на который загружен PHP-файл Adspect. Например, если вы указали путь
  `/landers/landing.html` и загрузили PHP-файл Adspect по ссылке `https://example.com/ads/index.php`, то он будет отображать
  страницу `https://example.com/landers/landing.html`.

- Относительные пути считаются относительно директории, в которую загружен PHP-файл Adspect. Например, если вы указали путь
  `landers/landing.html` и загрузили PHP-файл Adspect по ссылке `https://example.com/ads/index.php`, то он будет отображать
  страницу `https://example.com/ads/landers/landing.html`.

- Ссылки также могут быть указаны. В этом случае доменная часть будет отрезана. Например, вы можете указать ссылку
  `https://google.com/landing.html`, и Adspect будет обращаться к пути `/landing.html` на вашем фактическом домене, на
  на который загружен PHP-файл Adspect.

Обычно указывается путь к файлу HTML-страницы или PHP-скрипта. В этом случае *крайне желательно* размещать фильтрующий
PHP-файл Adspect в той же директории. Если вы укажете в пути поддиректорию, то это поломает все относительные ссылки
на конечной странице, т.к. браузер посетителя не будет знать, что в этих путях появилась поддиректория --- нет редиректа,
через который он мог бы о ней узнать.

Вы можете указать путь к локальной директории, не указывая конкретный файл в ней. В этом случае Adspect попытается найти
и отобразить файл `index.php`, `index.html` или `index.htm` в этой директории, проверяя их наличие в указанном порядке.
Это поведение подобно тому, как веб-сервер ищет индексный файл при обращении к директории. Такая практика чревата ошибками
и не рекомендуется.

Вы также можете указать путь к не-HTML файлу. Браузер посетителя скачает этот файл, если не сможет отобразить его содержимое.
Например, вы можете указать вашу контент-страницу как `downloads/app.apk`, чтобы "заклоачить" скачивание APK.

:::{admonition} JavaScript-интеграция
Загружает целевую страницу при помощи синхронного `XMLHttpRequest` и заменяет ею контент белой страницы без перенаправления.
Действие сработает только в том случае, если контент и белая страница расположены на одном домене, либо если контент-страница
отдается веб-сервером с правильно настроенным
[заголовком Access-Control-Allow-Origin](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/Access-Control-Allow-Origin),
разрешающим [cross-origin resource sharing (CORS)](https://developer.mozilla.org/ru/docs/Web/HTTP/CORS).
:::

(reverse-proxy)=
### Проксирование

[Проксирование](https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D1%80%D0%B0%D1%82%D0%BD%D1%8B%D0%B9_%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8) ---
это отображение стороннего сайта на вашем домене при помощи умного HTTP-проксирования. Фактически проксирование создает
"на лету" динамическую копию сайта с сохранением навигации внутри него. Большинство сайтов проксируются без ошибок,
однако в некоторых частных случаях результат может быть поломан или искажен.

Это действие подходит для отображения чужих сайтов на своем домене в качестве белой страницы.
**Не рекомендуется для отображения контента, т.к. проксирование может сломать внутреннюю логику страницы.**

:::{admonition} JavaScript-интеграция
Загружает целевую страницу при помощи синхронного `XMLHttpRequest` и заменяет ею контент белой страницы без перенаправления.
Действие сработает только в том случае, если контент и белая страница расположены на одном домене, либо если контент-страница
отдается веб-сервером с правильно настроенным
[заголовком Access-Control-Allow-Origin](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/Access-Control-Allow-Origin),
разрешающим [cross-origin resource sharing (CORS)](https://developer.mozilla.org/ru/docs/Web/HTTP/CORS).
:::

(insert-html-code)=
### Подгрузка HTML-кода

Это действие является упрощенным видом проксирования: Adspect подгрузит HTML-код конечной страницы и вставит его
в текущую, не производя при этом сложную подмену ссылок для достижения бесшовной навигации. Это действие может
использоваться для подгрузки одностраничных лендингов со стороннего сервера без перенаправлений.

:::{admonition} JavaScript-интеграция
Загружает целевую страницу при помощи синхронного `XMLHttpRequest` и заменяет ею контент белой страницы без перенаправления.
Действие сработает только в том случае, если контент и белая страница расположены на одном домене, либо если контент-страница
отдается веб-сервером с правильно настроенным
[заголовком Access-Control-Allow-Origin](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/Access-Control-Allow-Origin),
разрешающим [cross-origin resource sharing (CORS)](https://developer.mozilla.org/ru/docs/Web/HTTP/CORS).
:::

(iframe)=
### Отображение в iframe

Отображение веб-страницы при помощи [HTML-тега `<iframe>`](http://htmlbook.ru/html/iframe)
без изменения ссылки в адресной строке браузера.

:::{attention}
Сайты могут запретить отображение своего контента в iframe при помощи заголовка ответа
[X-Frame-Options](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options),
из-за чего это действие может не работать.
:::

:::{warning}
Вопреки расхожему убеждению, iframe часто рассматривается рекламными сетями как перенаправление, т.к. процесс загрузки
фрейма приводит к видимому и легко отслеживаемому HTTP-запросу. Это действие не настолько безопасно, как может показаться.
Рекомендуем использовать отображение локального файла или проксирование вместо него.
:::

(redirect-301)=
### HTTP 301 Moved Permanently

[HTTP 301 Moved Permanently](https://developer.mozilla.org/ru/docs/Web/HTTP/Status/301) --- постоянное перенаправление.
Эти перенаправления могут быть закэшированы браузерами, то есть при повторном переходе по защищенной Adspect ссылке
браузер может сразу перенаправить посетителя туда же, куда его перенаправили при первом переходе, то есть в обход фильтров.

:::{attention}
Кэширование перенаправления остается на усмотрение браузера. На него не стоит полагаться, если на кону стоит безопасность.
:::

:::{admonition} JavaScript-интеграция
Перенаправление при помощи функции `location.replace()`.
:::

(redirect-302)=
### HTTP 302 Found

[HTTP 302 Found](https://developer.mozilla.org/ru/docs/Web/HTTP/Status/302) --- это обычное перенаправление (редирект),
каким его обычно знают, также известное как временное перенаправление. Эти перенаправления не кэшируются браузерами, поэтому
повторный переход по "заклоаченной" ссылке приведет к повторному срабатыванию фильтров.

:::{tip}
Если вы не знаете, какой тип перенаправления выбрать, то выбирайте HTTP 302 Found.
:::

:::{admonition} JavaScript-интеграция
Перенаправление при помощи функции `location.replace()`.
:::

(redirect-303)=
### HTTP 303 See Other

[HTTP 303 See Other](https://developer.mozilla.org/ru/docs/Web/HTTP/Status/303) --- еще один вид перенаправления, который
по механике идентичен HTTP 302 Found.

:::{admonition} JavaScript-интеграция
Перенаправление при помощи функции `location.replace()`.
:::

(no-action)=
### Без действия

Ничего не произойдет; посетитель останется там, куда перешел. Это действие предназначено для использования совместно с
[обратной PHP-интеграцией](integration.md#id3). Оно также может быть использовано для пассивного трекинга переходов без
фильтрации трафика: интегрируйте поток в ваш сайт и укажите "Без действия" для контента и белой страницы.

(http-refresh)=
### Заголовок HTTP Refresh

Специальный вид HTTP-перенаправления, который совместим с кодом ответа HTTP 200 OK.  При использовании в комбинации с
[обратной PHP-интеграцией](integration.md#id3) это действие также возвращает содержимое страницы, в которую был
интегрирован код Adspect.

:::{admonition} JavaScript-интеграция
Перенаправление при помощи функции `location.replace()`.
:::

(meta-refresh)=
### HTML meta refresh

Перенаправление средствами [HTML-тега `<meta>`](https://developer.mozilla.org/ru/docs/Web/HTML/Element/meta),
которое в остальном идентично предыдущему действию с заголовком Refresh и имеет то же целевое применение.
Некоторые виды "тупых" ботов не обрабатывают это перенаправление.

:::{admonition} JavaScript-интеграция
Перенаправление при помощи функции `location.replace()`.
:::

(http-response-code)=
### Произвольный код ответа HTTP

Возвращает [произвольный код ответа HTTP](https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2_%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F_HTTP),
указанный в поле страницы, например `404` для отображения типичной страницы "404 Not Found".
Это действие может быть использовано для симуляции ошибки сервера при помощи кодов 50x,
либо для явного отказа в доступе при помощи кода 403.

:::{admonition} JavaScript-интеграция
Это действие ничего не делает при JavaScript-интеграции.
:::

(execute-php-code)=
### Выполнить PHP-код

Выполняет PHP-код, указанный в поле страницы, например:
```php
echo '<h1>Hello, world!</h1>';
```

:::{admonition} JavaScript-интеграция
Это действие ничего не делает при JavaScript-интеграции.
:::

(execute-js-code)=
### Выполнить JavaScript-код

Выполняет JavaScript-код, указанный в поле страницы, например:

```js
document.write("<h1>Hello, world!</h1>");
```

С помощью этого действия можно реализовать сложную логику обработки перехода, такую как добавление или удаление
элементов белой страницы, изменение стилей элементов, подключение скриптов и пикселей и т.п.
Наилучшим образом сочетается с [JavaScript-интеграцией](integration.md#javascript).

(x-accel-redirect)=
### Заголовок X-Accel-Redirect

Это действие позволяет Adspect взаимодействовать с веб-приложениями, не использующими PHP. Оно возвращает ответ 200 OK с
[заголовком X-Accel-Redirect](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/) --- это механизм
внутрисерверного перенаправления, поддерживаемый веб-серверами NGINX и Cherokee.

Настройку лучше всего показать на примере.  Предположим, у вас есть блок `location` в конфигурации NGINX, который отвечает за
веб-приложение на Node.js (или проксирует сторонний сайт, отдает статические файлы, что угодно), и вы хотите его использовать в
качестве контента в Adspect:

```nginx
location /app {
  internal;
  proxy_pass http://127.0.0.1:8080/;
}
```

Вам нужно добавить еще один блок `location`, который будет принимать запросы к домену и отправлять их в файл интеграции потока
`index.php`:

```nginx
location ~ \.php$ {
  root /var/www/html;
  include fastcgi.conf;
  fastcgi_pass unix:/run/php/php-fpm.sock;
}
```

Останется лишь настроить поток, чтобы он использовал ваше веб-приложение в качестве контента:

* Поле контента: `/app`
* Действие контента: **Заголовок X-Accel-Redirect**

При такой настройке все целевые переходы будут бесшовно перенаправлены в ваше веб-приложение внутри NGINX без какого-либо видимого
редиректа для посетителя.

:::{admonition} JavaScript-интеграция
Перенаправление при помощи функции `location.replace()`.
:::

(x-sendfile)=
### Заголовок X-Sendfile

Возвращает 200 OK с [заголовком X-Sendfile](https://tn123.org/mod_xsendfile/) ---
это механизм внутрисерверного перенаправления, поддерживаемый веб-серверами Apache, Cherokee и Lighttpd.

:::{admonition} JavaScript-интеграция
Перенаправление при помощи функции `location.replace()`.
:::

(filtering-settings)=
## Настройки фильтрации

Эта группа настроек отвечает за основные параметры фильтрации трафика при помощи встроенных фильтров Adspect.

(filtering-level)=
### Уровень фильтрации

Уровень фильтрации позволяет вам настроить "агрессивность" фильтрации трафика путем выбора одного из нескольких уровней.

:::{list-table} Доступные уровни фильтрации
:header-rows: 1

* - Уровень
  - Описание

* - 0. Минимальный
  - Все встроенные и внешние фильтрационные базы данных отключены. Машинное обучение VLA™ не используется. Не выбирайте этот уровень
    без крайней необходимости.

* - 1. Низкий
  - Заблокированы только самые основные угрозы: IT-корпорации, крупнейшие хостинги и датацентры, антивирусные компании и т.п.
    Машинное обучение VLA™ не используется. Данный уровень подходит для клоакинга приложений и WebView.

* - 2. Средний
  - Заблокированы все IT-корпорации, датацентры, хостинги и провайдеры IP-транзита. Машинное обучение VLA™ включено. Все переходы
    также проверяются по двенадцати конкурирующим сервисам клоакинга.

* - 3. Высокий
  - Как "Средний", плюс включает проверку принадлежности IP-сетей заблокированным организациям за последние 3 года. Также переходы
    проверяются по внешним базам данных и поставщикам риск-скоринга. Данный уровень безопасен для большинства ситуаций.

* - 4. Паранойя
  - Как "Высокий", плюс заблокированы все правительственные, военные, научные и образовательные учреждения, а также некоторые
    высокорисковые Интернет-провайдеры. Данный уровень наиболее безопасен, но может привести к повышенной потере трафика.
:::

:::{tip}
Если вы не знаете, какой уровень фильтрации выбрать, то используйте "Высокий".
:::

(js-fingerprinting)=
### Включить фильтрацию по JavaScript-отпечаткам и обучение модели VLA™

:::{warning}
Этот фильтр должен быть выключен при использовании PHP-интеграции для Google Ads.
:::

Данная настройка контролирует JavaScript-фингерпринтинг --- одну из самых надежных и передовых технологий
фильтрации трафика Adspect. Если настройка включена, то посетители, прошедшие все "наивные" проверки
(по IP-адресу, user agent, referrer, таргетингам, URL-правилам и т.п.), подвергнутся JavaScript-проверке:
они получат небольшой скрипт, который соберет массив данных о внутреннем устройстве браузера и отправит нам.
Этот массив называется JavaScript-отпечатком браузера.

Получив отпечаток, Adspect проанализирует его более чем сотней эвристик в поисках признаков ботов, программного
обеспечения для браузерной автоматизации, подмены данных об ОС и браузере и других нежелательных сигнатур.
Далее этот же отпечаток пройдет вероятностный анализ нашей [моделью машинного обучения VLA™](how-it-works.md#vla).

(filter-by-user-agents)=
### Включить фильтрацию по встроенным спискам user agent

Эта настройка позволяет вам включать и выключать встроенные фильтры по строке user agent браузеров посетителей.
Аналогично черным спискам IP-адресов, фильтры user agent постоянно поддерживаются нами в актуальном состоянии.

:::{attention}
Мы настоятельно рекомендуем оставлять эту настройку включенной во всех случаях.
:::

(require-unique)=
### Пропускать только уникальных посетителей

Если эта настройка включена, то только первый переход с каждого IP-адреса будет допущен до контента; все последующие
переходы с того же IP-адреса будут заблокированы.

(require-touchscreen)=
### Требовать поддержку touchscreen

Эта настройка позволяет вам требовать наличия поддержки touchscreen (сенсорного экрана) в устройствах посетителей.
Если настройка включена, а поддержка touchscreen отсутствует, то посетитель будет заблокирован. Это бывает удобно
в рекламных кампаниях, таргетированных только на мобильный трафик и современные телефоны и планшеты.
Одной этой настройки будет достаточно, чтобы отсечь множество модерирующих и антивирусных ботов, которые построены
на базе десктопных браузеров.

(allow-apps)=
### Разрешить трафик из мобильных приложений

Эта настройка говорит нам пропускать трафик из мобильных приложений в общем порядке, не считая его априори фродовым.
Примером такого трафика являются переходы, сделанные из браузера WebView на платформе Android. Этот трафик
является естественным для некоторых нишевых рекламных форматов, но в традиционных форматах рекламы он очень часто
оказывается накруткой (автоматическими кликами, выполняемыми зараженными вирусами мобильными устройствами) и поэтому
должен быть отфильтрован. Включайте настройку только в том случае, если ваш рекламный формат так или иначе основан
на мобильных приложениях.

(allow-frames)=
### Разрешить трафик из фреймов (в том числе iframe), элементов embed и object

Эта настройка говорит нам пропускать трафик из встраиваемых элементов, таких как `<iframe>`, `<embed>` и `<object>`.
Как и в случае с мобильными приложениями, эта настройка зависит от конкретного формата и источника трафика.
Если вы не уверены что выбрать, то оставьте ее включенной.

(targeting)=
## Таргетинг

(countries-os-browsers-etc)=
### Страны, операционные системы, браузеры, движки, языки и часовые пояса

Эти настройки ручного таргетинга позволяют вам ограничить круг потенциальных посетителей контента только указанными
странами, операционными системами, браузерами, движками, языками и часовыми поясами. Обычно следует указывать те же
таргетинги, что и в рекламной кампании. Если та или иная настройка не задана (список пуст), то проверка по ней
не производится.

Настройка часовых поясов ограничена полночасовыми смещениями относительно UTC. Если часовой пояс посетителя смещен
относительно UTC на неполное число часов (например, Индия UTC+5.5), то смещение округляется до ближайшего полного часа
(в примере с Индией до UTC+5).

(match-time-zone-to-ip)=
### Проверять соответствие часового пояса браузера и местоположения

Если эта настройка включена, то Adspect будет отфильтровывать всех посетителей, у которых часовой пояс браузера
не совпадает с часовым поясом их фактического местоположения, определенного при помощи нашей геолокации. Эта проверка
немного повышает вероятность ложноположительных срабатываний, однако значительно улучшает защиту от модераторов и ботов,
использующих VPN- и прокси-сервисы. При включенной проверке описанный выше ручной список часовых поясов игнорируется.
Мы рекомендуем включить эту настройку.

(tracking)=
## Трекинг

Данные настройки отвечают за назначание Sub ID, Click ID и цены отдельным кликам. Adspect берет значение каждого поля, заменяет в
нем макросы и записывает результат в соответствующий атрибут каждого клика.

Заполнять эти поля не обязательно, но может быть полезно, если вы хотите отслеживать клики, конверсии, расход, доход и статистику с
разбивкой по площадкам в разделе ["Статистика"](reporting.md) вашего личного кабинета Adspect.

(sub-id)=
### Sub ID

Sub ID --- это атрибут клика, по которому можно делать разбивку в [статистике](reporting.md), выбрав "Sub ID" в поле разбивки.
Принцип работы проще всего показать на примере. Возьмем рекламную сеть, у которой есть понятие номеров площадок, на которых
показываются рекламные объявления. Номер площадки, с которой пришел клик, помещается в рекламную ссылку для передачи в Adspect
при помощи макроса, например `{zoneid}`:
```
https://example.com/?subid={zoneid}
```
Для каждого клика рекламная сеть заменит этот макрос `{zoneid}` фактическим номером площадки, с которой пришел клик,
а далее Adspect извлечет его из кликовой ссылки для сбора статистики. В данном примере `subid` является параметром
ссылки, в котором содержится номер площадки. Если вы укажете `{p:subid}` в поле "Sub ID" в настройках потока, то сможете получать
статистику по каждой отдельной площадке в потоке и составлять черные или белые списки площадок в зависимости от числа ботов на них.

(click-id)=
### Click ID

Поле Click ID работает по тому же принципу, что и Sub ID, но используется для назначения идентификаторов отдельным кликам, которые
затем используются для отстука конверсий в трекер или рекламную сеть при помощи пикселя или через механизм S2S postback.

Часто клики приходят в Adspect с уже добавленными рекламной платформой уникальными click ID, например, в параметре ссылки
`gclid` в Google Ads или `fbclid` в Facebook. Поле Click ID в потоке позволяет вам извлечь этот идентификатор из URL-параметра
и назначить его каждому отдельному клику в статистике. Для этого укажите в этом поле макрос `{p:gclid}` (в примере для Google Ads)
или `{p:fbclid}` (в примере для Facebook).

Далее click ID может быть передан на контент или белую страницу при помощи макроса `{clickid}`.

Если поле Click ID не заполнено, то Adspect будет самостоятельно генерировать уникальные click ID.

(cost)=
### Цена клика

В этом поле задается цена каждого клика, которая будет использоваться для расчета расходов в [статистике](reporting.md).
Вы можете указать здесь фиксированное число, но бывает удобнее передавать цену клика из рекламной сети в параметре ссылки, если
это поддерживается вашей рекламной сетью. Например, посетитель перешел по ссылке вида:
```
https://example.com/?cost=0.15
```
Если вы укажете в поле цены клика макрос `{p:cost}`, то Adspect запишет этот переход в статистику с ценой 0.15, которую возьмет из
параметра ссылки `cost`.

Если поле цены клика не заполнено, то переходы будут записаны в статистику с нулевой ценой.

(delayed-start)=
## Отложенный запуск

Отложенный запуск позволяет вам заблокировать определенное число первых переходов по потоку. Например, если вы заметили,
что первые 10--15 переходов по рекламе в вашем источнике трафика принадлежат модераторам и антивирусным ботам, то вы
можете настроить отложенный запуск на 20 переходов (чуть больше, чтобы наверняка), то есть отправить их на белую страницу.

:::{attention}
Отложенный запуск работает только когда поток находится в режиме "Фильтр".
:::

Отложенный запуск имеет три режима, которые отличаются логикой работы счетчика переходов:

| Режим   | Описание |
|:--------|:---------|
| Все     | Учитываются все переходы. |
| Контент | Учитываются только целевые переходы, которые по всем остальным фильтрам прошли бы на контент (за исключением фильтра по JavaScript-отпечаткам). |
| Белая   | Учитываются только нецелевые переходы, заблокированные любым из фильтров. |

:::{tip}
Отложенный запуск удобен, если вы запускаете множество рекламных кампаний и не можете или не хотите следить за каждой из них,
чтобы вовремя переключить режим потока с "Модерация" на "Фильтр".
:::

(ip-address-filtering)=
## Фильтрация по IP-адресам

Данный блок настроек позволяет вам фильтровать трафик по спискам IP-адресов, диапазонов IP-адресов,
[CIDR-префиксов](https://ru.wikipedia.org/wiki/%D0%91%D0%B5%D1%81%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%BE%D0%B2%D0%B0%D1%8F_%D0%B0%D0%B4%D1%80%D0%B5%D1%81%D0%B0%D1%86%D0%B8%D1%8F) и
[номеров автономных систем (ASN)](https://ru.wikipedia.org/wiki/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_(%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82)).
У каждого потока есть два списка: белый и черный.

Примеры форматов записи:

```
192.0.2.1
192.0.2.0/24
192.0.2.0–192.0.2.255
2001:db8::1
2001:db8::/112
2001:db8::-2001:db8::ffff
65536
AS65536
1.10
AS1.10
```

Разделяйте отдельные элементы списка переносами строки или пробелами.

(ip-list-mode)=
### Режим фильтрации IP/ASN

Режим фильтрации IP/ASN управляет тем, как черный и белый списки взаимодействуют друг с другом.

| Режим       | Описание |
|:------------|:---------|
| Черный      | Посетитель будет отфильтрован, если его IP-адрес или ASN находится в черном списке и отсутствует в белом. |
| Белый       | Посетитель будет отфильтрован, если его IP-адрес или ASN находится в черном списке **или** отсутствует в белом. |
| Специальный | Посетитель будет отфильтрован, если его IP-адрес или ASN находится в черном списке. Если IP-адрес или ASN находится в белом списке, то такой посетитель будет допущен до контента в обход всех остальных проверок. |

(blacklist-review-ips)=
### Заносить все IP-адреса в черный список в режиме "Модерация"

Если эта настройка включена, то Adspect будет автоматически заносить IP-адреса всех посетителей в потоке в черный
список, если поток работает в режиме "Модерация". Так как этот режим предназначен именно для прохождения модерации,
то будет справедливо считать всех посетителей модераторами, а следовательно запоминать и блокировать в дальнейшем.
Мы рекомендуем вам всегда включать эту опцию, но будьте внимательны и не пропустите момент, когда вашу кампанию
одобрят, --- вам нужно успеть переключить поток в режим "Фильтр" прежде, чем польется трафик, иначе в черный список
попадут IP-адреса обычных посетителей.

(ip-extrapolation)=
### IP-экстраполяция

IP-экстраполяция позволяет вам настроить точность проверки внутренних черных списков IP-адресов.
Чем выше значения, тем большее число адресов, соседних с уже заблокированными диапазонами, будет заблокировано.
Это повышает уровень защиты, но вместе с тем и шансы получить ложноположительные блокировки.

(user-agent-and-referrer)=
## User agent и referrer

Эта настройка позволяет вам указать собственные списки [Perl-совместимых регулярных выражений (PCRE)](http://www.pcre.ru/docs/perl/text/intro/)
для фильтрации посетителей по их [строке user agent](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent).
Сравнение производится с учетом регистра символов. По умолчанию поиск вхождения производится в любой части строки
user agent; вы можете использовать якоря `^` и `$` для привязки шаблона к началу или концу строки (см. примеры ниже).

Синтаксис PCRE очень богатый и мощный и находится за рамками данной документации. Отдельные выражения могут быть
объединены с помощью различных синтаксических конструкций, что позволяет создавать сколь угодно сложные шаблоны,
однако обратите внимание, что в текущей реализации длина регулярного выражения не может превышать 1023 символа.

Несколько примеров:

```
Firefox|Nexus|Miui
```

Это выражение совпадет с любым user agent, который содержит слова "Firefox", "Nexus" или "Miui". Его можно
использовать для фильтрации посетителей с Mozilla Firefox, Google Nexus и встроенного браузера Xiaomi.

```
^Mozilla/4[.]0
```

Это выражение совпадет с любым user agent, который начинается с "Mozilla/4.0". Оно отфильтрует всех подозрительных
посетителей, которые якобы используют очень старые браузеры, но тем не менее поддерживают современные конструкции
JavaScript (подразумевается тем, что посетитель смог сформировать машинный отпечаток.)

```
^Mozilla/5[.]0$
```

Это выражение отфильтрует тех посетителей, чей user agent строго совпадает с "Mozilla/5.0", то есть не содержит
сведений о конкретном бразуре, HTML-движке и платформе, что очень необычно и подозрительно.

Все выражения выше могут быть объединены в одно с использованием логического "или" (т.е. совпадет первое *или* второе
*или* третье) следующим образом:

```
Firefox|Nexus|Miui|^Mozilla/4[.]0|^Mozilla/5[.]0$
```

**Внимание! Неправильно сформированное регулярное выражение может привести к ошибочным срабатываниям
и фильтрации больших объемов хорошего трафика. Используйте эту настройку только если вы точно знаете что делаете.**

Указывайте каждое регулярное выражение на отдельной строке.

(user-agent-list-mode)=
### Режим фильтрации user agent

Режим фильтрации user agent управляет тем, как черный и белый списки взаимодействуют для определения, следует ли
отфильтровать того или иного посетителя. Имеется три режима:

* **Черный**: посетитель будет отфильтрован только если его user agent есть в черном списке и отсутствует в белом.
  Таким образом, белый список задает исключения для черного списка. Этот режим установлен по умолчанию.

* **Белый**: посетитель будет отфильтрован, если его user agent отсутствует в белом списке или есть в черном.
  Таким образом, черный список задает исключения для белого списка.

* **Специальный**: посетитель будет отфильтрован только если его user agent есть в черном списке. Если user agent
  находится в белом списке, то такой посетитель будет допущен до контента в обход всех остальных проверок.

(referrer-filter)=
### Фильтр referrer

Эта настройка работает по тому же принципу, что описанный выше фильтр user agent, но в отношении
[HTTP referrer](https://developer.mozilla.org/ru/docs/Web/HTTP/%D0%97%D0%B0%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%BA%D0%B8/Referer).
Adspect отфильтрует всех посетителей, чей referrer совпадет с указанным Perl-совместимым регулярным выражением.
Сравнение производится с учетом регистра символов.

Типичные способы применения:

- Фильтрация посетителей с пустым referrer-ом:
  ```
  ^$
  ```
- Фильтрация посетителей, перешедших не по рекламной ссылке. Пример для Google Ads:
  ```
  ^(.(?!google[.]))*$
  ```

**Внимание! Неправильно сформированное регулярное выражение может привести к ошибочным срабатываниям
и фильтрации больших объемов хорошего трафика. Используйте эту настройку только если вы точно знаете что делаете.**

(url-rules)=
## URL-правила

URL-правила позволяют вам проверять и измененять значения URL-параметров. Каждое правило описывается следующими составными частями:

* **Параметр** --- имя параметра в ссылке, который будет проверяться или изменяться;
* **Оператор** --- конкретная проверка или операция, которая будет произведена;
* **Аргумент** --- аргумент оператора, если он применим (поддерживаются макросы);
* **Переключатель "Вкл"** --- включает/выключает правило.

:::{table} Операторы URL-правил

| Оператор | Описание |
|:---------|:---------|
| `EXISTS` | Проверяет, что параметр существует (аргумент игнорируется). |
| `! EXISTS` | Проверяет, что параметр не существует (аргумент игнорируется). |
| `REGEX` | Проверяет параметр на совпадение с [Perl-совместимым регулярным выражением (PCRE)](http://www.pcre.ru/docs/perl/text/intro/) в аргументе (с учетом регистра). |
| `REGEX (no case)` | Проверяет параметр на совпадение с регулярным выражением в аргументе (без учета регистра). |
| `! REGEX` | Проверяет параметр на несовпадение с регулярным выражением в аргументе (с учетом регистра). |
| `! REGEX (no case)` | Проверяет параметр на несовпадение с регулярным выражением в аргументе (без учета регистра). |
| =, ≠, >, ≥, <, ≤ | Сравнивают параметр с аргументом; целочисленные и вещественные значения сравниваются как числа, строки сравниваются в соответствии с [лексикографическим порядком](https://ru.wikipedia.org/wiki/%D0%9B%D0%B5%D0%BA%D1%81%D0%B8%D0%BA%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D0%BF%D0%BE%D1%80%D1%8F%D0%B4%D0%BE%D0%BA). |
| `ASSIGN` | Назначает параметру значение из аргумента. |
| `RENAME` | Переименовывает параметр в аргумент. |
| `DELETE` | Удаляет параметр из ссылки (аргумент игнорируется). |
:::

(schedule)=
## Расписание

Расписание позволяет вам указывать временные интервалы и дни недели, в которые фильтрация трафика будет включена.
Все посетители в другие временные интервалы или дни будут заблокированы. Расписание включается только если указан
хотя бы один временной интервал. Если в интервале не указаны дни недели, то он применяется ко всем дням.
