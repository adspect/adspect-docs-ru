# REST API

Adspect предоставляет REST API для автоматизации различных задач:

* [Создания, изменения и удаления потоков](api.md#streams)
* [Скачивания PHP-файлов интеграции](api.md#integration)
* [Управления гостевым доступом к статистике](api.md#guest-access-to-reporting)
* [Получения статистики](api.md#reporting-api): построения воронок продаж и выгрузки логов переходов
* [Получения информации об аккаунте](api.md#account-information)
* [Управления черными/белыми списками IP/ASN](api.md#ip-asn-lists)

Базовым URL для всех точек вызова является `https://api.adspect.net/v1/`. Описания точек вызова ниже указывают пути относительно
этого базового URL. Сначала указывается HTTP-метод, за которым следует относительный путь точки вызова, например:

```
GET /streams
```

Это описание означает GET-запрос на URL `https://api.adspect.net/v1/streams`.

API поддерживает JSON- и XML-кодирование данных. В примерах ниже будет использовано JSON-кодирование для простоты.

(authentication)=
## Аутентификация

Для аутентификации в API используется [HTTP-аутентификация типа Basic](https://developer.mozilla.org/ru/docs/Web/HTTP/%D0%90%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F#Basic_authentication_scheme),
в которой ключ API передается в качестве имени пользователя, а пароль оставляется пустым. Ваш ключ API находится в
[настройках вашего аккаунта](https://clients.adspect.io/account).

Каждый запрос к API должен содержать два обязательных HTTP-заголовка:

:::{list-table}
:header-rows: 1

* - Заголовок
  - Значение
  - Описание

* - `Authorization`
  - `Basic AUTHKEY`
  - Аутентификация в Adspect при помощи ключа API (см. ниже).

* - `Content-Type`
  - `application/json` или `application/xml`
  - Выбор JSON- или XML-кодирования данных, соответственно.
:::

Поле `AUTHKEY` в заголовке Authorization формируется путем [base64-кодирования](https://ru.wikipedia.org/wiki/Base64) строки,
составленной из ключа API и добавленного в конце двоеточия.

Пример кода на PHP:

```{code-block} php
:emphasize-lines: 3
:lineno-start: 1

<?php
$apiKey = 'SEbMw152aoe2ArffS7yjEJzJ_MFnd33e';
$authKey = base64_encode($apiKey . ':');
```

:::{tip}
Для удобства вы можете взять готовое значение `AUTHKEY` в [настройках вашего аккаунта](https://clients.adspect.io/account)
в поле "Заголовок Authorization".
:::

Некоторые HTTP-клиенты имеют нативную поддержку аутентификации HTTP Basic и самостоятельно добавляют заголовок `Authorization`.
Например, [Python Requests](https://docs.python-requests.org/en/latest/) предоставляет класс `requests.auth.HTTPBasicAuth`.
В этом случае укажите ваш ключ API в качестве имени пользователя и оставьте пароль пустым. Пример для
[php-curl](https://www.php.net/manual/ru/book.curl.php):

```php
<?php
$apiKey = 'SEbMw152aoe2ArffS7yjEJzJ_MFnd33e';
$curl = curl_init();
curl_setopt($curl, CURLOPT_USERPWD, $apiKey . ':');
```

(collections)=
## Коллекции

Некоторые свойства объектов могут принимать значения только из строго заданных множеств --- коллекций. 
В таблице ниже приводятся точки вызова для получения коллекций:

:::{list-table}
:header-rows: 1

* - Точка вызова
  - Описание

* - `GET /collections/presets`
  - Шаблоны потоков (цели использования) для различных источников трафика.

* - `GET /collections/os`
  - Операционные системы для таргетинга и статистики.

* - `GET /collections/browsers`
  - Браузеры для таргетинга и статистики.

* - `GET /collections/engines`
  - Движки браузера для таргетинга и статистики.

* - `GET /collections/countries`
  - Коды стран для таргетинга и статистики.

* - `GET /collections/languages`
  - Коды языков для таргетинга и статистики.

* - `GET /collections/time-zones`
  - Часовые пояса для таргетинга и статистики.

* - `GET /collections/stream-modes`
  - Режимы потока.

* - `GET /collections/stream-actions`
  - Действия для контента и белой страницы [(см. ниже)](api.md#stream-actions).

* - `GET /collections/query-group-by`
  - Элементы разбивки для воронки продаж.

* - `GET /collections/query-funnel-metrics`
  - Колонки метрик воронки продаж.

* - `GET /collections/query-log-columns`
  - Колонки лога переходов.
:::

(stream-actions)=
### Действия потока

Следующая таблица описывает действия для контента и белой страницы:

:::{list-table}
:header-rows: 1

* - Действие
  - Описание

* - `local`
  - [Локальный файл без редиректа](streams.md#local-file).

* - `proxy`
  - [Проксирование](streams.md#reverse-proxy).

* - `fetch`
  - [Подгрузка HTML-кода](streams.md#insert-html-code).

* - `iframe`
  - [Отображение в iframe](streams.md#iframe).

* - `301`
  - [Редирект HTTP 301](streams.md#redirect-301).

* - `302`
  - [Редирект HTTP 302](streams.md#redirect-302).

* - `303`
  - [Редирект HTTP 303](streams.md#redirect-303).

* - `noop`
  - [Без действия](streams.md#no-action).

* - `refresh`
  - [Редирект HTTP Refresh](streams.md#http-refresh).

* - `meta`
  - [Редирект HTML meta refresh](streams.md#meta-refresh).

* - `assign`
  - [JavaScript-редирект assign()](streams.md#js-assign).

* - `replace`
  - [JavaScript-редирект replace()](streams.md#js-replace).

* - `top`
  - [Выход из фрейма](streams.md#frame-break).

* - `return`
  - [Произвольный код ответа HTTP](streams.md#http-response-code).

* - `php`
  - [Выполнить PHP-код](streams.md#execute-php-code).

* - `js`
  - [Выполнить JavaScript-код](streams.md#execute-js-code).

* - `xar`
  - [Заголовок X-Accel-Redirect](streams.md#x-accel-redirect).

* - `xsf`
  - [Заголовок X-Sendfile](streams.md#x-sendfile).
:::

(streams)=
## Управление потоками

Поток представляется в виде объекта со следующими свойствами:

:::{list-table}
:header-rows: 1

* - Свойство
  - Тип
  - Описание

* - `stream_id`
  - Строка
  - ID потока.

* - `account_id`
  - Строка
  - ID аккаунта. Только для чтения.

* - `name`
  - Строка
  - Имя потока.

* - `preset`
  - Строка
  - [Шаблон потока (цель использования)](api.md#collections). Только для записи.

* - `tags`
  - Массив строк
  - Теги, до 32 штук.

* - `mode`
  - Строка
  - Режим потока, один из:<br><br>
    `Filter` --- фильтр<br>
    `Review` --- модерация<br>
    `Money` --- контент<br>
    `White` --- белая страница

* - `notes`
  - Строка
  - Любые заметки, которые вы хотели бы записать.

* - `money_pages`
  - Массив объектов
  - Массив контент-страниц, до 32 объектов, каждый со следующими свойствами:<br><br>
    `page` --- URL / путь к файлу / код (в зависимости от действия), строка<br>
    `action` --- действие, производимое с посетителем, строка<br>
    `arg_passthru` --- включить проброс URL-параметров, логический<br>
    `weight` --- вес при ротации, целое число<br>
    `enabled` --- включить контент-страницу, логический

* - `rotator`
  - Строка
  - Ротатор контент-страниц: `Split` (сплит) или `Timer` (таймер).

* - `safe_pages`
  - Массив из одного объекта
  - Белая страница. Массив из одного объекта со следующими свойствами:<br><br>
    `page` --- URL / путь к файлу / код (в зависимости от действия), строка<br>
    `action` --- действие, производимое с посетителем, строка<br>
    `arg_passthru` --- включить проброс URL-параметров, логический

* - `skip_clicks`
  - Целое число
  - Число первых переходов, которые будут отфильтрованы (отложенный запуск).

* - `skip_clicks_mode`
  - Строка
  - Режим пропуска переходов, один из:<br><br>
    `all` --- все: счетчик пропущенных переходов уменьшается при каждом переходе<br>
    `money` --- контент: счетчик переходов уменьшается с каждым легитимным посетителем<br>
    `safe` --- белая: счетчик переходов уменьшается с каждым ботом, модератором и т.п.

* - `filter_level`
  - Целое число или строка
  - Уровень фильтрации, один из:<br><br>
    0 или `Off` --- минимальный<br>
    1 или `Low` --- низкий<br>
    2 или `Medium` --- средний<br>
    3 или `High` --- высокий<br>
    4 или `Paranoid` --- паранойя

* - `enable_fp`
  - Логический
  - Включить фильтрацию по JavaScript-отпечаткам и обучение модели VLA™.

* - `enable_ua`
  - Логический
  - Включить фильтрацию по встроенным спискам user agent.

* - `require_unique`
  - Логический
  - Пропускать только уникальных посетителей.

* - `require_touch`
  - Логический
  - Пропускать только устройства с сенсорным экраном.

* - `allow_apps`
  - Логический
  - Пропускать трафик из мобильных приложений.

* - `allow_embed`
  - Логический
  - Пропускать трафик из фреймов, iframe, элементов embed и object.

* - `countries`
  - Массив строк
  - Разрешенные коды стран в [двухбуквенном формате](https://ru.wikipedia.org/wiki/ISO_3166-1_alpha-2).

* - `os`
  - Массив строк
  - Разрешенные операционные системы.

* - `browsers`
  - Массив строк
  - Разрешенные браузеры.

* - `engines`
  - Массив строк
  - Разрешенные движки браузера.

* - `languages`
  - Массив строк
  - Разрешенные коды языков браузера.

* - `require_language`
  - Логический
  - Блокировать переходы без информации о языках браузера.

* - `sub_id`
  - Строка
  - [Sub ID](streams.md#sub-id).

* - `click_id`
  - Строка
  - [Click ID](streams.md#click-id).

* - `click_cost`
  - Строка
  - [Цена клика](streams.md#cost).

* - `ip_list_mode`
  - Строка
  - Режим фильтрации, один из:<br><br>
    `black` --- черный: блокировать IP-адреса/ASN из черного списка, если их нет в белом списке<br>
    `white` --- белый: блокировать IP-адреса/ASN из черного списка или не из белого списка<br>
    `special` --- специальный: блокировать IP-адреса/ASN из черного списка, пропускать из белого списка.

* - `ip_on_review`
  - Логический
  - Заносить все IP-адреса в черный список в режиме "Модерация".

* - `extrapolate_ipv4`
  - Целое число в интервале 0 и 255
  - IPv4-экстраполяция.

* - `extrapolate_ipv6`
  - Целое число в интервале 0 и 64
  - IPv6-экстраполяция.

* - `ua_list_mode`
  - Строка
  - Режим фильтрации user agent, один из:<br><br>
    `black` --- черный: блокировать user agent из черного списка, если их нет в белом списке<br>
    `white` --- белый: блокировать user agent из черного списка или не из белого списка<br>
    `special` --- специальный: блокировать user agent из черного списка, пропускать из белого списка.

* - `ua_blacklist`
  - Строка или массив строк
  - Черный список user agent.

* - `ua_whitelist`
  - Строка или массив строк
  - Белый список user agent.

* - `referer_regex`
  - Строка
  - Регулярное выражение для фильтрации по referrer-у.

* - `url_rules`
  - Массив объектов
  - URL-правила. См. [структуру объекта URL-правила](#url-rule-object).

* - `schedule`
  - Массив объектов
  - Расписание. См. [структуру объекта расписания](#schedule-rule-object).

* - `timezones`
  - Массив целых чисел
  - Разрешенные часовые пояса в виде часовых сдвигов относительно UTC.

* - `tz_match_ip`
  - Логический
  - Проверять соответствие часового пояса браузера и местоположения.
:::

Пример:

```json
{
  "stream_id": "1eacc6d0-875f-6f5c-bff8-00162501c2b4",
  "account_id": "1eaa2ce5-d4dd-63ec-b8a4-00162501c2b4",
  "name": "Example Stream",
  "tags": ["Tag1", "Tag2"],
  "mode": "Filter",
  "notes": "This is an example comment.",
  "money_pages": [
    {
      "page": "https://example.com/offer1?clid={clickid}",
      "action": "302",
      "arg_passthru": true,
      "weight": 10,
      "enabled": true
    },
    {
      "page": "https://example.com/offer2?clid={clickid}",
      "action": "302",
      "arg_passthru": true,
      "weight": 20,
      "enabled": true
    }
  ],
  "rotator": "Split",
  "safe_pages": [
    {
      "page": "safe.html",
      "action": "local",
      "arg_passthru": true
    }
  ],
  "skip_clicks": 30,
  "skip_clicks_mode": "all",
  "filter_level": "High",
  "enable_fp": true,
  "enable_ua": true,
  "require_unique": true,
  "require_touch": false,
  "allow_apps": false,
  "allow_embed": true,
  "countries": ["AE", "HK"],
  "os": ["iOS", "macOS"],
  "browsers": ["Google Chrome"],
  "engines": ["Blink"],
  "languages": ["en", "fr", "es"],
  "require_language": true,
  "sub_id": "{p:utm_campaign}",
  "click_id": "{p:gclid}",
  "click_cost": "0.15",
  "ip_list_mode": "black",
  "ip_on_review": true,
  "extrapolate_ipv4": 0,
  "extrapolate_ipv6": 0,
  "ua_list_mode": "black",
  "ua_blacklist": [
    "^Mozilla/4"
  ],
  "referer_regex": "^(.(?!google[.]))*$",
  "url_rules": [
    {
      "param": "gclid",
      "op": "REGEX",
      "arg": ".{30,}",
      "enabled": true
    }
  ],
  "schedule": [
    {
      "days": ["Sun", "Sat"],
      "since": "15:30:00",
      "till": "22:15:00"
    }
  ],
  "timezones": [-5, -6, -7],
  "tz_match_ip": true
}
```

### Объект URL-правила

Объект URL-правила имеет следующую структуру:

```json
{
  "param": "gclid",
  "op": "REGEX",
  "arg": "[[:alnum:]-_]{55,}",
  "enabled": true
}
```

:::{list-table} Свойства объекта URL-правила
:header-rows: 1

* - Свойство
  - Тип
  - Описание

* - `param`
  - Строка
  - Имя URL-параметра, с которым работает правило.

* - `op`
  - Строка
  - Оператор правила. См. таблицу операторов ниже.

* - `arg`
  - Строка
  - Аргумент оператора. См. таблицу операторов ниже.

* - `enabled`
  - Логический
  - Включает правило.
:::

:::{list-table} Операторы URL-правил
:header-rows: 1

* - Оператор
  - Аргумент
  - Описание

* - `ASSIGN`
  - Необязательный
  - Назначает параметру значение аргумента.

* - `RENAME`
  - Необязательный
  - Меняет имя параметра на значение аргумента.

* - `DELETE`
  - Игнорируется
  - Удаляет параметр.

* - `EXISTS`
  - Игнорируется
  - Проверяет, что параметр существует.

* - `NEXISTS`
  - Игнорируется
  - Проверяет, что параметр не существует.

* - `REGEX`
  - Необязательный
  - Проверяет, что значение параметра совпадает с регулярным выражением в аргументе.

* - `IREGEX`
  - Необязательный
  - Проверяет, что значение параметра совпадает с регулярным выражением в аргументе (без учета регистра).

* - `NREGEX`
  - Необязательный
  - Проверяет, что значение параметра не совпадает с регулярным выражением в аргументе.

* - `NIREGEX`
  - Необязательный
  - Проверяет, что значение параметра не совпадает с регулярным выражением в аргументе (без учета регистра).

* - `EQ`
  - Необязательный
  - Проверяет, что значение параметра равно аргументу.

* - `NEQ`
  - Необязательный
  - Проверяет, что значение параметра не равно аргументу.

* - `GT`
  - Необязательный
  - Проверяет, что значение параметра меньше аргумента.

* - `GE`
  - Необязательный
  - Проверяет, что значение параметра больше или равно аргументу.

* - `LT`
  - Необязательный
  - Проверяет, что значение параметра меньше аргумента.

* - `LE`
  - Необязательный
  - Проверяет, что значение параметра меньше или равно аргументу.
:::

### Объект расписания

Объект расписания имеет следующую структуру:

```json
{
  "days": ["Sun", "Sat"],
  "since": "15:30:00",
  "till": "22:15:00"
}
```

:::{list-table} Свойства объекта расписания
:header-rows: 1

* - Свойство
  - Тип
  - Описание

* - `days`
  - Массив строк
  - Дни недели, к которым относится правило:<br><br>
    `Mon` --- понедельник<br>
    `Tue` --- вторник<br>
    `Wed` --- среда<br>
    `Thu` --- четверг<br>
    `Fri` --- пятница<br>
    `Sat` --- суббота<br>
    `Sun` --- воскресенье

* - `since`
  - Строка
  - Пропускать посетителей со времени суток в формате `HH:MM:SS`, например `15:30:00`.

* - `till`
  - Строка
  - Пропускать посетителей до времени суток в формате `HH:MM:SS`, например `22:15:00`.
:::


### Список потоков

```
GET /streams
```

Эта точка вызова возвращает список потоков в аккаунте. Список разбивается на страницы, а потоки в нем
выводятся в возрастающем [лексикографическом порядке](https://ru.wikipedia.org/wiki/%D0%9B%D0%B5%D0%BA%D1%81%D0%B8%D0%BA%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D0%BF%D0%BE%D1%80%D1%8F%D0%B4%D0%BE%D0%BA)
их имен.

Поддерживаемые URL-параметры:

:::{list-table}
:header-rows: 1

* - Параметр
  - Тип
  - Значение по умолчанию
  - Описание

* - `page`
  - Целое число
  - 1
  - Номер страницы для отображения.

* - `per-page`
  - Целое число от 1 до 100
  - 20
  - Число потоков на страницу.

* - `name`
  - Строка
  - Нет
  - Выводит только те потоки, в имени которых содержится указанная подстрока (без учета регистра).
:::

### Данные о списке потоков

```
HEAD /streams
```

Эта точка вызова возвращает заголовки с общей информацией о числе потоков и страниц:

:::{list-table}
:header-rows: 1

* - Заголовок
  - Тип
  - Описание

* - `X-Pagination-Total-Count`
  - Целое число
  - Общее число потоков.

* - `X-Pagination-Page-Count`
  - Целое число
  - Общее число страниц.
:::

Поддерживаемые URL-параметры:

:::{list-table}
:header-rows: 1

* - Параметр
  - Тип
  - Значение по умолчанию
  - Описание

* - `per-page`
  - Целое число от 1 до 100
  - 20
  - Число потоков на страницу.
:::

### Получение потока

```
GET /streams/<ID>
```

Эта точка вызова возвращает поток `<ID>`.

### Создание потока

```
POST /streams
```

Эта точка вызова создает и возвращает новый поток. Укажите объект потока в теле запроса.
Все свойства объекта потока имеют значения по умолчанию, поэтому вам нужно указывать только те свойства,
значения которых вы хотите задать явно, например `{"name":"My Stream"}`.

### Обновление потока

```
PATCH /streams/<ID>
```

Эта точка вызова обновляет поток `<ID>`. Укажите объект потока в в теле запроса.
Вам нужно указать только те свойства, значения которых вы хотите изменить; все остальные свойства
останутся неизменными.

### Копирование потока

```
COPY /streams/<ID>
```

Эта точка вызова копирует поток `<ID>`. Укажите объект потока в теле запроса ---
указанные в нем свойства заменят свойства в скопированном потоке, что сэкономит вам дополнительный
вызов точки `PATCH`. Если свойства изменять не требуется, то укажите пустой объект `{}`.

### Удаление потока

```
DELETE /streams/<ID>
```

Эта точка вызова удаляет поток `<ID>`.

(integration)=
## PHP-файлы интеграции

```
GET /streams/<ID>/file?name=index.php
GET /streams/<ID>/file?name=filter.php
GET /streams/<ID>/file?name=ajax.php
```

Эта точка вызова возвращает файлы интеграции `index.php`, `filter.php` и `ajax.php` для потока `<ID>`.

(guest-access-to-reporting)=
## Гостевой доступ к статистике

Гостевой доступ к статистике позволяет третьим лицам просматривать заранее определенные фрагменты вашей статистики
без необходимости входа в систему. Управление гостевым доступом производится при помощи сохраненных запросов:

1. Создается сохраненный запрос к статистике, в котором указываются параметры выгрузки отчета (даты и фильтры);
2. В ответ API передает ID сохраненного запроса;
3. Гость может выполнить этот сохраненный запрос на [странице статистики](https://clients.adspect.io/reporting),
   указав ID сохраненного запроса в соответствующем поле, либо перейдя по ссылке вида
   `https://clients.adspect.io/reporting?query_id=<ID>`, где вместо `<ID>` подставляется ID сохраненного запроса.

:::{note}
Можно создавать не более 100 сохраненных запросов.
:::

Сохраненный запрос представляется в виде объекта со следующими свойствами:

:::{list-table}
:header-rows: 1

* - Свойство
  - Тип
  - Описание

* - `query_id`
  - Строка
  - ID сохраненного запроса. Только для чтения.

* - `owner_id`
  - Строка
  - ID аккаунта владельца запроса. Только для чтения.

* - `date_from`
  - Целое число или строка
  - Минимальное Unix-время, начиная с которого выгружается отчет.

* - `date_to`
  - Целое число или строка
  - Максимальное Unix-время, до которого выгружается отчет.

* - `time_zone`
  - Строка
  - Часовой пояс по умолчанию для отображения дат и времени.

* - `group_by`
  - Массив строк
  - Разбивка воронки продаж по умолчанию.

* - `stream_id`
  - Массив строк
  - Фильтр по ID потоков.

* - `ip_address`
  - Массив строк
  - Фильтр по IP-адресам.

* - `asn`
  - Массив целых чисел или строк
  - Фильтр по [номерам автономных систем (ASN)](https://ru.wikipedia.org/wiki/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_(%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82)). ASN могут быть заданы строками вида `AS65536` или `AS1.10`.

* - `country_code`
  - Массив строк
  - Фильтр по кодам стран в [двухбуквенном формате](https://ru.wikipedia.org/wiki/ISO_3166-1_alpha-2).

* - `os`
  - Массив строк
  - Фильтр по операционным системам.

* - `browser`
  - Массив строк
  - Фильтр по браузерам.

* - `engine`
  - Массив строк
  - Фильтр по движкам браузера.

* - `sub_id`
  - Массив строк
  - Фильтр по [sub ID](streams.md#sub-id).

* - `click_id`
  - Массив строк
  - Фильтр по [ID переходов](streams.md#click-id).

* - `mode`
  - Массив строк
  - Фильтр по режимам потока.

* - `target`
  - Массив целых чисел
  - Фильтр по показанным страницам:<br><br>
    0 --- белая страница<br>
    1--255 --- контент-страница с соответствующим порядковым номером
:::

Все поля необязательны. Если тот или иной фильтр не требуется, то его можно не указывать, либо задать значение `null`
(или пустой массив `[]` там, где типом значения является массив).

Пример:

```json
{
  "query_id": "878efbf1-0fb9-4c69-ad36-40e714b0eeeb",
  "owner_id": "1eb5991f-a25b-68f4-b171-00162501c2b4",
  "date_from": 1577836800,
  "date_to": null,
  "time_zone": "Asia/Dubai",
  "group_by": [],
  "account_id": ["1eb5991f-a25b-68f4-b171-00162501c2b4"],
  "stream_id": ["6792f6ce-f153-439f-b223-f58749f1210f"],
  "ip_address": [],
  "asn": [],
  "country_code": ["HK", "AE"],
  "os": ["iOS", "macOS"],
  "browser": ["Apple Safari"],
  "engine": [],
  "sub_id": [],
  "click_id": [],
  "mode": ["Filter"],
  "target": []
}
```

### Список запросов

```
GET /reports
```

Эта точка вызова возвращает список запросов в аккаунте, разбитый на страницы.

Поддерживаемые URL-параметры:

:::{list-table}
:header-rows: 1

* - Параметр
  - Тип
  - Значение по умолчанию
  - Описание

* - `page`
  - Целое число
  - 1
  - Номер страницы для отображения.

* - `per-page`
  - Целое число от 1 до 100
  - 20
  - Число запросов на страницу.
:::

### Данные о списке запросов

```
HEAD /reports
```

Эта точка вызова возвращает заголовки с общей информацией о числе запросов и страниц:

:::{list-table}
:header-rows: 1

* - Заголовок
  - Тип
  - Описание

* - `X-Pagination-Total-Count`
  - Целое число
  - Общее число запросов.

* - `X-Pagination-Page-Count`
  - Целое число
  - Общее число страниц.
:::

Поддерживаемые URL-параметры:

:::{list-table}
:header-rows: 1

* - Параметр
  - Тип
  - Значение по умолчанию
  - Описание

* - `per-page`
  - Целое число от 1 до 100
  - 20
  - Число потоков на страницу.
:::

### Получение запроса

```
GET /reports/<ID>
```

Эта точка вызова возвращает сохраненный запрос `<ID>`.

### Создание запроса

```
POST /reports
```

Эта точка вызова создает и возвращает новый запрос. Укажите объект запроса в теле HTTP-запроса.

### Обновление запроса

```
PATCH /reports/<ID>
```

Эта точка вызова обновляет запрос `<ID>`. Укажите объект запроса в теле HTTP-запроса.
Вам нужно указать только те свойства, значения которых вы хотите изменить; все остальные свойства
останутся неизменными.

### Копирование запроса

```
COPY /reports/<ID>
```

Эта точка вызова копирует запрос `<ID>`. Укажите объект запроса в теле HTTP-запроса ---
указанные в нем свойства заменят свойства в скопированном запросе, что сэкономит вам дополнительный
вызов точки `PATCH`.

### Удаление запроса

```
DELETE /reports/<ID>
```

Эта точка вызова удаляет запрос `<ID>`.

(reporting-api)=
## API статистики

API статистики предоставляет вам программный доступ к статистике Adspect через две точки вызова:

* [Воронка продаж](api.md#reporting-sales-funnel) для создания агрегированных отчетов;
* [Лог переходов](api.md#reporting-click-log) для получения сырых данных о кликах и конверсиях.

Они функционально идентичны [разделу "Статистика"](reporting.md) личного кабинета Adspect.

(reporting-filters)=
### Фильтры

Обе точки вызова поддерживают фильтры в виде URL-параметров для ограничения выборки статистических данных, например:

```
date_from=1672520400&date_to=1675198800&country_code[]=AE&os[]=iOS&os[]=macOS
```

Отчет, сформированный с такими фильтрами, будет содержать только клики и конверсии, отвечающие **всем** условиям:

* за январь 2023 года: `date_from=1672520400&date_to=1675198800`
* из Объединенных Арабских Эмиратов: `country_code[]=AE`
* с устройств iOS **или** macOS: `os[]=iOS&os[]=macOS`

:::{tip}
Вы можете указывать дату и время в свободном формате вместо временных меток Unix. Например, `1 Jan 2023` или `2023-01-01` вместо
`1672520400`. Adspect постарается максимально точно распарсить такую строку.
:::

Следующая таблица перечисляет доступные параметры фильтров. Все параметры являются необязательными.

:::{note}
Параметры, заканчивающиеся на `[]`, являются массивами: вы можете указать несколько таких параметров, и их значения будут
объединены логическим **ИЛИ**. Например, фильтр `os[]=iOS&os[]=macOS` отберет те клики и конверсии, которые были сделаны с
устройств iOS **или** macOS.
:::

:::{list-table}
:header-rows: 1

* - Параметр
  - Тип
  - Описание

* - `query_id`
  - Строка
  - [ID сохраненного запроса](api.md#guest-access-to-reporting) для гостевого доступа к статистике других пользователей Adspect.

* - `date_from`
  - Целое число или строка
  - Минимальное Unix-время, начиная с которого выгружается отчет.

* - `date_to`
  - Целое число или строка
  - Максимальное Unix-время, до которого выгружается отчет.

* - `time_zone`
  - Строка
  - Часовой пояс для отображения дат и времени, например, `Asia/Dubai`.

* - `stream_id[]`
  - Строка
  - Фильтр по ID потоков.

* - `ip_address[]`
  - Строка
  - Фильтр по IP-адресам.

* - `asn[]`
  - Целое число или строка
  - Фильтр по [номерам автономных систем (ASN)](https://ru.wikipedia.org/wiki/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_(%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82)). ASN могут быть заданы строками вида `AS65536` или `AS1.10`.

* - `country_code[]`
  - Строка
  - Фильтр по кодам стран в [двухбуквенном формате](https://ru.wikipedia.org/wiki/ISO_3166-1_alpha-2).

* - `os[]`
  - Строка
  - Фильтр по операционным системам.

* - `browser[]`
  - Строка
  - Фильтр по браузерам.

* - `engine[]`
  - Строка
  - Фильтр по движкам браузера.

* - `sub_id[]`
  - Строка
  - Фильтр по [sub ID](streams.md#sub-id).

* - `click_id[]`
  - Строка
  - Фильтр по [ID переходов](streams.md#click-id).

* - `mode[]`
  - Строка
  - Фильтр по режимам потока.

* - `target[]`
  - Целое число
  - Фильтр по показанной странице:<br><br>
    0 --- белая страница<br>
    1--255 --- контент-страница с соответствующим порядковым номером
:::

(reporting-sales-funnel)=
### Воронка продаж

```
GET /reports/funnel
```

Эта точка вызова возвращает агрегированный отчет (воронку продаж). Каждая строка отчета является JSON-массивом, порядок элементов
которого соответствует порядку параметров `group_by[]` и затем порядку параметров `metrics[]`.

Следующая таблица перечисляет URL-параметры, специфичные для точки вызова воронки продаж.

:::{note}
Параметры, заканчивающиеся на `[]`, являются массивами: вы можете указать несколько таких параметров, и их значения будут
объединены. Например, разбивка `group_by[]=date&group_by[]=stream_id` сгруппирует воронку сначала по дате, а затем по ID потока.

Аналогично, параметры `metrics[]=clicks&metrics[]=money_hits` добавят в отчет колонки числа кликов и переходов на контент в
указанном порядке.
:::

:::{list-table}
:header-rows: 1

* - Параметр
  - Тип
  - Описание

* - `group_by[]`
  - Строка, необязательный
  - Добавляет [колонку разбивки](api.md#reporting-sales-funnel-breakdown) в отчет.

* - `metrics[]`
  - Строка, **обязательный**
  - Добавляет [колонку метрики](api.md#reporting-sales-funnel-metrics) в отчет.
:::

(reporting-sales-funnel-breakdown)=
#### Колонки разбивки воронки продаж

Следующая таблица перечисляет доступные колонки разбивки воронки продаж для URL-параметра `group_by[]`.

:::{list-table}
:header-rows: 1

* - Колонка
  - Описание

* - `date`
  - Дата в формате `YYYY-MM-DD`.

* - `month`
  - Месяц в формате `YYYY-MM`.

* - `stream_id`
  - ID потока.

* - `asn`
  - [Номер автономной системы (ASN)](https://ru.wikipedia.org/wiki/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_(%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82)).

* - `country_code`
  - [Двухбуквенный код страны](https://ru.wikipedia.org/wiki/ISO_3166-1_alpha-2).

* - `os`
  - Операционная система.

* - `browser`
  - Браузер.

* - `engine`
  - Движок браузера.

* - `language`
  - Язык браузера.

* - `sub_id`
  - [Sub ID](streams.md#sub-id).

* - `mode`
  - Режим потока в момент перехода.

* - `target`
  - Показанная страница:<br><br>
    0 --- белая страница<br>
    1--255 --- контент-страница с соответствующим порядковым номером

* - `tag`
  - [Тег](reporting.md#tags), обозначающий причину блокировки перехода.
:::

:::{tip}
Этот список можно получить при помощи точки вызова [GET /collections/query-group-by](api.md#collections)
:::

(reporting-sales-funnel-metrics)=
#### Колонки метрик воронки продаж

Следующая таблица перечисляет доступные колонки метрик воронки продаж для URL-параметра `metrics[]`.

:::{important}
Пожалуйста, указывайте в API-запросе только те метрики, которые вам нужны.
:::

:::{list-table}
:header-rows: 1

* - Метрика
  - Описание

* - `clicks`
  - Общее число переходов.

* - `uniques`
  - Приблизительное число уникальных посетителей с точки зрения уникальности их IP-адресов.

* - `fingerprints`
  - Число посетителей, которые при обработке успешно сформировали и передали JavaScript-отпечаток. По различным причинам это число может быть меньше, чем общее число переходов, но как правило разницу составляют "тупые" боты, которые не поддерживают JavaScript.

* - `money_hits`
  - Число показов контент-страницы.

* - `money_uniques`
  - Число уникальных посетителей, которым была показана контент-страница.

* - `safe_hits`
  - Число показов белой страницы.

* - `givt`
  - ["General invalid traffic"](https://integralads.com/insider/givt-vs-sivt-invalid-traffic/)&nbsp;--- число посетителей, заблокированных по поверхностным признакам, таким как IP-адрес, строка user agent, таргетинг и т.п.

* - `sivt`
  - ["Sophisticated invalid traffic"](https://integralads.com/insider/givt-vs-sivt-invalid-traffic/)&nbsp;--- число посетителей, заблокированных алгоритмами Adspect на основании их JavaScript-отпечатков.

* - `mia`
  - Число посетителей, которые не смогли сформировать и отправить JavaScript-отпечаток (технические потери). Как упоминалось ранее, это как правило "тупые" боты с ограниченной поддержкой JavaScript. Другая распространенная причина технических потерь&nbsp;--- сетевые задержки, особенно наглядные при работе с трафиком с плохим Интернет-соединением типа 3G/EDGE: посетители успевают закрыть окно или вкладку прежде, чем отпечаток будет отправлен.

* - `quality`
  - Процент показов контент-страницы от общего числа кликов. Это наилучший показатель для оценки качества трафика в целом и может быть использован для сравнения различных источников, площадок, спотов и т.п. Особую ценность представляет [сбор черных или белых списков площадок](use-cases.md#detecting-bot-zones) на основании их качества.

* - `expenses`
  - Расход, считаемый как сумма цен переходов, если они [были переданы через параметр ссылки](streams.md#cost).

* - `conversions`
  - Число конверсий.

* - `cr`
  - Коэффициент конверсии =&nbsp;конверсии&nbsp;:&nbsp;клики.

* - `revenue`
  - Доход, считаемый как сумма выплат по конверсиям, если они [были переданы через postback](tracker.md#postback).

* - `profit`
  - Прибыль или убыток =&nbsp;доход&nbsp;−&nbsp;расход.

* - `roi`
  - Возврат инвестиций =&nbsp;прибыль&nbsp;:&nbsp;расход.

* - `cpc`
  - Средняя цена перехода =&nbsp;расход&nbsp;:&nbsp;переходы.

* - `cpm`
  - Средняя стоимость тысячи переходов =&nbsp;CPC&nbsp;∙&nbsp;1000.

* - `cpa`
  - Средняя цена лида =&nbsp;расход&nbsp;:&nbsp;конверсии.

* - `epl`
  - Средний доход с лида =&nbsp;доход&nbsp;:&nbsp;конверсии.

* - `ecpc`
  - Средний доход с перехода =&nbsp;доход&nbsp;:&nbsp;переходы.

* - `ecpm`
  - Средний доход с тысячи переходов =&nbsp;доход&nbsp;:&nbsp;переходы&nbsp;∙&nbsp;1000.
:::

:::{tip}
Этот список можно получить при помощи точки вызова [GET /collections/query-funnel-metrics](api.md#collections)
:::

(reporting-sales-funnel-examples)=
#### Примеры

**Пример #1:** получение статистики для всех потоков с группировкой по ID потока:

```
GET /reports/funnel?group_by[]=stream_id&metrics[]=clicks&metrics[]=money_hits&metrics[]=safe_hits&metrics[]=quality
```

```json
["1ec5880e-bcb6-49b8-9778-a31d22b70708", "1453", "754", "699", 0.5189263592567103]
["07ac03df-268e-41ff-84ba-adfe2241beb2", "3219", "2034", "1125", 0.6318732525629077]
["7a3d39f7-fe75-431e-8be6-9ea9b56b1e4a", "179", "0", "179", 0]
["9f79b75f-20ef-4654-8141-b8bbb2124ec4", "65", "0", "65", 0]
```

**Пример #2:** получение статистики по дням для потока с ID `07ac03df-268e-41ff-84ba-adfe2241beb2`:

```
GET /reports/funnel?group_by[]=date&metrics[]=clicks&metrics[]=money_hits&metrics[]=safe_hits&metrics[]=quality&stream_id[]=07ac03df-268e-41ff-84ba-adfe2241beb2
```

```json
["2024-04-01", "931", "343", "582", 0.3684210526315789]
["2024-04-02", "1166", "829", "300", 0.7109777015437393]
["2024-04-03", "1113", "855", "243", 0.7681940700808625]
["2024-04-04", "9", "7", "0", 0.7777777777777778]
```

(reporting-click-log)=
### Лог переходов

```
GET /reports/log
```

Эта точка вызова возвращает лог переходов. Каждая строка отчета является JSON-массивом, порядок элементов которого соответствует
порядку параметров `columns[]`.

Следующая таблица перечисляет URL-параметры, специфичные для точки вызова лога переходов.

:::{note}
Параметры, заканчивающиеся на `[]`, являются массивами: вы можете указать несколько таких параметров, и их значения будут
объединены. Например, параметры `columns[]=timestamp&columns[]=ip_address` добавят в отчет колонки временной метки и IP-адреса в
указанном порядке.
:::

:::{list-table}
:header-rows: 1

* - Параметр
  - Тип
  - Описание

* - `columns[]`
  - Строка, **обязательный**
  - Добавляет [колонку лога переходов](api.md#reporting-click-log-columns) в отчет.
:::

(reporting-click-log-columns)=
#### Колонки лога переходов

Следующая таблица перечисляет доступные колонки лога переходов для URL-параметра `columns[]`.

:::{important}
Пожалуйста, указывайте в API-запросе только те колонки, которые вам нужны.
:::

:::{list-table}
:header-rows: 1

* - Колонка
  - Описание

* - `timestamp`
  - Дата и время перехода или конверсии.

* - `ip_address`
  - IP-адрес.

* - `asn`
  - [Номер автономной системы (ASN)](https://ru.wikipedia.org/wiki/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_(%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B5%D1%82)).

* - `account_id`
  - ID аккаунта.

* - `stream_id`
  - ID потока.

* - `country_code`
  - [Двухбуквенный код страны](https://ru.wikipedia.org/wiki/ISO_3166-1_alpha-2).

* - `os`
  - Операционная система.

* - `browser`
  - Браузер.

* - `engine`
  - Движок браузера.

* - `languages`
  - Список языков браузера.

* - `cost`
  - Цена перехода или выплата по конверсии.

* - `sub_id`
  - [Sub ID](streams.md#sub-id).

* - `click_id`
  - [ID перехода](streams.md#click-id).

* - `mode`
  - Режим потока в момент перехода.

* - `sequence`
  - Этап обработки перехода:<br><br>
    0 --- базовая проверка<br>
    1 --- проверка JavaScript-отпечатка<br>
    255 --- конверсия

* - `target`
  - Показанная страница:<br><br>
    0 --- белая страница<br>
    1--255 --- контент-страница с соответствующим порядковым номером

* - `tags`
  - Список [тегов](reporting.md#tags), обозначающих причины блокировки перехода.
:::

:::{tip}
Этот список можно получить при помощи точки вызова [GET /collections/query-log-columns](api.md#collections)
:::

(reporting-click-log-examples)=
#### Примеры

Получение лога переходов за сегодня для потока с ID `07ac03df-268e-41ff-84ba-adfe2241beb2`:

```
GET /reports/log?columns[]=timestamp&columns[]=ip_address&columns[]=country_code&columns[]=target&date_from=today&date_to=tomorrow&stream_id[]=07ac03df-268e-41ff-84ba-adfe2241beb2
```

```json
["2024-04-01 00:00:00", "23.83.90.68", "US", 0]
["2024-04-01 00:00:00", "2a03:2880:30ff:8::33", "SE", 0]
["2024-04-01 00:00:00", "47.128.19.245", "SG", 0]
["2024-04-01 00:00:00", "176.223.109.119", "US", 0]
["2024-04-01 00:00:00", "2a03:2880:20ff:76::33", "US", 0]
["2024-04-01 00:00:00", "89.248.163.208", "NL", 0]
["2024-04-01 00:00:00", "47.128.98.197", "SG", 0]
["2024-04-01 00:00:00", "47.128.25.161", "SG", 0]
["2024-04-01 00:00:00", "95.90.237.130", "DE", 0]
["2024-04-01 00:00:00", "176.5.15.114", "DE", 0]
```

(account-information)=
## Информация об аккаунте

```
GET /account
```

Эта точка вызова возвращает информацию о вашем аккаунте.

Аккаунт представляется в виде объекта со следующими свойствами:

:::{list-table}
:header-rows: 1

* - Свойство
  - Тип
  - Описание

* - `account_id`
  - Строка
  - ID аккаунта.

* - `email`
  - Строка
  - Адрес электронной почты.

* - `telegram`
  - Строка
  - Имя пользователя в Telegram.

* - `language`
  - Строка
  - Код языка интерфейса.

* - `timezone`
  - Строка
  - Часовой пояс по умолчанию.

* - `balance`
  - Числовая строка
  - Баланс в условных единицах.

* - `expires`
  - Целочисленный
  - Unix-время окончания подписки Adspect.

* - `expires_comsign`
  - Целочисленный
  - Unix-время окончания подписки генератора вайтов Comsign.

* - `comsign_limit`
  - Целочисленный
  - Тарифный лимит скачиваний вайтов Comsign.

* - `comsign_extra_limit`
  - Целочисленный
  - Докупленный лимит скачиваний вайтов Comsign.
:::

(ip-asn-lists)=
## Списки IP/ASN

Есть несколько точек вызова, которые позволяют получать и изменять черные/белые списки IP/ASN потоков и вашего аккаунта.

Эти точки вызова возвращают или принимают JSON-массивы диапазонов IP-адресов или ASN, представленных в виде строк:

```json
[
  "192.0.2.1",
  "192.0.2.0/24",
  "192.0.2.0-192.0.2.255",
  "2001:db8::1",
  "2001:db8::/112",
  "2001:db8::-2001:db8::ffff",
  "65536",
  "AS65536",
  "1.10",
  "AS1.10"
]
```

### Получение списка IP/ASN

```
GET /streams/<id>/ip-blacklist
GET /streams/<id>/ip-whitelist
GET /accounts/self/ip-blacklist
GET /accounts/self/ip-whitelist
```

Эти точки вызова возвращают указанный список как JSON-массив.

### Добавление элементов в список IP/ASN

```
POST /streams/<id>/ip-blacklist
POST /streams/<id>/ip-whitelist
POST /accounts/self/ip-blacklist
POST /accounts/self/ip-whitelist
```

Эти точки вызова добавляют новые элементы в указанный список.  Укажите элементы для добавления в виде JSON-массива в теле запроса.

### Замена списка IP/ASN

```
PUT /streams/<id>/ip-blacklist
PUT /streams/<id>/ip-whitelist
PUT /accounts/self/ip-blacklist
PUT /accounts/self/ip-whitelist
```

Эти точки вызова заменяют указанный список целиком новыми элементами.  Укажите новые элементы в виде JSON-массива в теле запроса.

### Удаление элементов списка IP/ASN

Удаление отдельных элементов списка IP/ASN пока не поддерживается. Если вам нужно удалить отдельные элементы, то сначала получите
весь список через точку вызова `GET`, измените массив как вам нужно и затем замените им текущий список через точку вызова `PUT`.

Если вам нужно удалить все элементы списка IP/ASN, то используйте точку вызова `PUT` с пустым массивом `[]`.
